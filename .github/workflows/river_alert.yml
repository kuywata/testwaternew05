name: River Alert

on:
  schedule:
    # รันทุก 15 นาที ปรับตามต้องการ
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  alert:
    runs-on: ubuntu-latest
    env:
      # ชี้ไปยังไบนารี Chrome และ Chromedriver
      CHROME_BIN: /usr/bin/google-chrome-stable
      CHROMEDRIVER_PATH: /usr/bin/chromedriver
      # นำค่า Token และ Threshold มาจาก GitHub secrets
      LINE_CHANNEL_ACCESS_TOKEN: ${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}
      NOTIFICATION_THRESHOLD_M: ${{ secrets.NOTIFICATION_THRESHOLD_M }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies (Chrome + Chromedriver)
        run: |
          sudo apt-get update

          # ติดตั้งเฉพาะ Chromedriver จาก APT ปกติ (ข้าม snap)
          sudo apt-get install -y chromium-chromedriver wget

          # ติดตั้ง Google Chrome Stable จาก .deb (ไม่ใช้ snap)
          wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
          sudo apt-get install -y ./google-chrome-stable_current_amd64.deb

          # ติดตั้ง Python requirements
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Run alert script
        run: python inburi_bridge_alert.py
